name: Eval Backend

on:
  pull_request:
    paths:
      - 'backend/**'
      - '.github/workflows/eval-backend.yml'
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

jobs:
  retrieval-gates:
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend
    env:
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements-prod.txt

      - name: Run retrieval-only evaluation
        run: python -m evaluation.evaluate --mode retrieval_only --top-k 5

      - name: Check retrieval gates
        run: python -m evaluation.check_gates --scope retrieval

  nightly-full-eval:
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend
    env:
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements-prod.txt

      - name: Run full evaluation with judges
        run: python -m evaluation.evaluate --mode full_rag_with_judges --top-k 5

      - name: Check full gates
        run: python -m evaluation.check_gates --scope full
